---
- name: Deploy, configure, and populate flask repo and virtualenv
  hosts: app_servers
  become: true
  gather_facts: false
  tags:
    - application_servers
  vars:
    flask_app_name: resource_hub
    flask_user: flask
    flask_home: /opt/
    flask_repo: https://github.com/tonykay/resource_hub.git  
    flask_scm_ref: main  
    virtualenv_name: "venv-{{ flask_app_name }}"  
    virtualenv_home: /opt/virtual_envs
    virtualenv_python: /usr/bin/python3
      

    app_yum_packages:
      - autoconf
      - automake
      - git
      - gcc
      - libtool
      - python3
      - python3-devel
      - python3-pip

    pip_dependencies:
      - virtualenv
      - pip  

  tasks:

    - name: Install flask packages
      package:
        name: "{{ __package }}"
        state: present
      loop: "{{ app_yum_packages }}"        
      loop_control:
        loop_var: __package

    - name: "Install flask repo {{ flask_repo }}"
      git:
        repo: "{{ flask_repo }}"
        dest: "{{ flask_home }}/{{ flask_app_name }}"
        update: yes 

    - name: virtualenv setup
      block:

        - name: Setup pre-requisite pip3 packages
          pip:
            name: "{{ pip_dependencies }}"
            state: latest
            executable: /usr/bin/pip3

        - name: "Create virtualenv {{ virtualenv_name }} for Flask"
          pip:
            requirements: "{{ flask_home }}/{{ flask_app_name }}/requirements.txt"
            virtualenv: "{{ virtualenv_home }}/{{ flask_app_name }}"
            virtualenv_site_packages: no
            virtualenv_command: /usr/local/bin/virtualenv
      tags:
        - venv
        - virtualenv  
          
    - name: Create flask user
      user:
        name: "{{ flask_user }}"
        state: present  

    - name:       
- name: template systemd service config
    copy:
      src: .service
      dest: /etc/systemd/system/{{ app_name }}.service
  - name: start systemd app service
    systemd: name={{ app_name }}.service state=restarted enabled=yes
